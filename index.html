<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaktik Silah AtÃ¶lyesi - Final Sistem</title>
    <style>
        /* --- TEMEL CSS (Ã–ncekilerle aynÄ±) --- */
        :root { --bg-dark: #0a0a0f; --bg-panel: #14141c; --text-light: #e0e0e0; --accent-gold: #c7a008; --nav-height: 60px; --blade-color: #0088ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-light); min-height: 100vh; padding-top: var(--nav-height); display: flex; flex-direction: column; }
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height); background: rgba(20, 20, 28, 0.95); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; backdrop-filter: blur(10px); }
        .brand { font-size: 1.2rem; font-weight: bold; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 1px;}
        .nav-links { list-style: none; display: flex; gap: 20px; }
        .nav-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1rem; padding: 8px 12px; transition: color 0.3s; border-radius: 4px; }
        .nav-btn:hover, .nav-btn.active { color: var(--accent-gold); }
        .cart-badge { background: var(--accent-gold); color: #000; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; margin-left: 5px;}
        .view-section { display: none; padding: 30px 20px; max-width: 1200px; margin: 0 auto; flex-grow: 1; width: 100%; }
        .view-section.active-view { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none !important; }
        
        /* --- YENÄ° CSS: ANA SAYFA KÃ–ÅžE REKLAMLARI --- */
        .hero-banner {
            text-align: center; padding: 100px 20px; background: radial-gradient(circle at center, #1a1a2e 0%, var(--bg-dark) 80%);
            position: relative; /* KÃ¶ÅŸe resimleri buna gÃ¶re konumlanacak */
            overflow: hidden; /* TaÅŸan kÄ±sÄ±mlarÄ± gizle */
        }
        .hero-title { font-size: 3rem; color: var(--accent-gold); margin-bottom: 20px; position: relative; z-index: 5;}
        .hero-subtitle { font-size: 1.2rem; color: #aaa; margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto; position: relative; z-index: 5;}
        .cta-btn { padding: 15px 40px; font-size: 1.2rem; background: var(--accent-gold); color: #000; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s; position: relative; z-index: 5;}
        .cta-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(199, 160, 8, 0.5); }

        /* Ortak reklam gÃ¶rseli stili */
        .corner-ad {
            position: absolute;
            width: 300px; /* GÃ¶rsel geniÅŸliÄŸi */
            height: auto;
            border-radius: 15px;
            border: 2px solid var(--accent-gold); /* AltÄ±n Ã§erÃ§eve */
            box-shadow: 0 0 30px rgba(199, 160, 8, 0.2); /* Hafif altÄ±n parÄ±ltÄ± */
            opacity: 0.5; /* Åžeffaf baÅŸlasÄ±n */
            transition: all 0.5s ease;
            z-index: 1; /* YazÄ±nÄ±n arkasÄ±nda */
            filter: grayscale(40%) contrast(1.1);
        }
        /* Ãœzerine gelince parlasÄ±n ve Ã¶ne Ã§Ä±ksÄ±n */
        .corner-ad:hover {
            opacity: 1;
            transform: scale(1.05) rotate(0deg) !important; /* DÃ¶nmeyi sÄ±fÄ±rla ve bÃ¼yÃ¼t */
            z-index: 10; /* YazÄ±nÄ±n Ã¶nÃ¼ne geÃ§sin */
            filter: grayscale(0%) contrast(1.2) brightness(1.1);
            box-shadow: 0 0 50px rgba(199, 160, 8, 0.6);
        }
        /* Sol Ãœst KÃ¶ÅŸe GÃ¶rseli */
        .ad-tl { top: -50px; left: -50px; transform: rotate(-20deg); }
        /* SaÄŸ Alt KÃ¶ÅŸe GÃ¶rseli */
        .ad-br { bottom: -50px; right: -50px; transform: rotate(15deg); }
        /* Mobilde gÃ¶rselleri kÃ¼Ã§Ã¼lt */
        @media (max-width: 768px) {
            .corner-ad { width: 150px; opacity: 0.3; }
            .ad-tl { top: -30px; left: -30px; }
            .ad-br { bottom: -30px; right: -30px; }
        }
        
        /* --- ATÃ–LYE & 3D CSS (Ã–ncekilerle aynÄ±) --- */
        .workshop-layout { display: grid; grid-template-columns: 1fr 400px; gap: 30px; align-items: start; }
        .workshop-preview { background: radial-gradient(circle at center, #2c3e50 0%, #000 80%); border-radius: 12px; min-height: 600px; display: flex; justify-content: center; align-items: center; border: 3px solid #333; position: relative; overflow: hidden; box-shadow: inset 0 0 50px #000; }
        .saber-container { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; transform: rotate(-90deg); }
        .panel { background: var(--bg-panel); padding: 25px; border-radius: 12px; border: 1px solid #333; max-height: 80vh; overflow-y: auto; }
        .panel h3 { color: var(--accent-gold); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; position: sticky; top: 0; background: var(--bg-panel); z-index: 10;}
        .part-category-title { font-size: 1rem; color: #fff; margin: 20px 0 10px 0; border-bottom: 1px dashed #555; padding-bottom: 5px; }
        .option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .color-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #555; cursor: pointer; transition: transform 0.2s; }
        .color-btn.active { border-color: #fff; transform: scale(1.2); box-shadow: 0 0 15px currentColor; }
        .part-btn { padding: 10px; background: #222; color: #aaa; border: 1px solid #444; border-radius: 6px; cursor: pointer; width: 100%; text-align: left; font-size: 0.9rem; display: flex; justify-content: space-between; transition: all 0.2s;}
        .part-btn:hover { background: #333; }
        .part-btn.active { background: var(--accent-gold); color: #000; font-weight: bold; border-color: var(--accent-gold); }
        .workshop-actions { margin-top: 30px; pt: 20px; border-top: 1px solid #444; text-align: center; position: sticky; bottom: 0; background: var(--bg-panel); padding-bottom: 10px;}
        .price-display { font-size: 2rem; color: var(--accent-gold); font-weight: bold; display: block; margin: 15px 0; }
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.2s; margin-bottom: 10px;}
        .btn-primary { background: var(--accent-gold); color: #000; }
        .btn-primary:hover { background: #d4af15; box-shadow: 0 0 15px rgba(199, 160, 8, 0.4); }
        .btn-secondary { background: #333; color: #fff; }
        .blade { width: 16px; height: 0; background: white; border-radius: 10px 10px 2px 2px; position: relative; top: 5px; transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease; z-index: 1; opacity: 0.8;}
        .saber-container.active .blade { height: 450px; opacity: 1; box-shadow: 0 0 10px #fff, 0 0 30px var(--blade-color), 0 0 80px var(--blade-color), 0 0 120px var(--blade-color); }
        .handle-assembly { display: flex; flex-direction: column; align-items: center; z-index: 10; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5)); }
        .hilt-part { width: 40px; position: relative; box-shadow: inset 0 5px 10px rgba(0,0,0,0.4), inset 0 -5px 10px rgba(0,0,0,0.4); transition: all 0.3s ease;}
        .tex-chrome { background: linear-gradient(to right, #555, #fff 40%, #ccc 60%, #555); }
        .tex-dark-metal { background: linear-gradient(to right, #111, #444 40%, #333 60%, #000); }
        .tex-gold { background: linear-gradient(to right, #9A7B4F, #FFD700 40%, #E6C200 60%, #9A7B4F); }
        .tex-copper { background: linear-gradient(to right, #6d4c41, #d7ccc8 40%, #bcaaa4 60%, #6d4c41); }
        .tex-leather { background: repeating-linear-gradient(to bottom, #5d4037, #4e342e 5px, #3e2723 10px); box-shadow: inset 0 0 20px rgba(0,0,0,0.8); }
        .tex-rubber { background: repeating-linear-gradient(to bottom, #212121, #151515 8px, #000 8px, #000 10px); }
        .emitter-graflex { height: 45px; border-radius: 5px 5px 0 0; border-top: 4px solid #222; }
        .emitter-graflex::after { content:''; position:absolute; top:-5px; left:50%; transform:translateX(-50%); width:25px; height:5px; background: var(--accent-gold); border-radius: 50%; }
        .emitter-obi { height: 30px; border-radius: 50% 50% 0 0; width: 36px; margin-bottom: 5px;}
        .emitter-obi-neck { height: 40px; width: 18px; margin: -5px auto 0 auto; border-top: 3px solid #000; border-bottom: 3px solid #000; z-index: 12;}
        .emitter-vader { height: 50px; border-radius: 2px; clip-path: polygon(0 0, 100% 15%, 100% 100%, 0 100%); }
        .emitter-crown { height: 40px; }
        .emitter-crown::before { content:''; position: absolute; width: 100%; height: 100%; background: repeating-linear-gradient(to right, transparent 0, transparent 8px, #000 8px, #000 10px); }
        .switch-clamp { height: 50px; z-index: 11; }
        .switch-clamp::before { content:''; position:absolute; top:50%; transform:translateY(-50%); left:-2px; width: 44px; height: 20px; background: rgba(0,0,0,0.5); border: 1px solid #fff; }
        .switch-box-red { height: 45px; }
        .switch-box-red::after { content:''; position:absolute; top:10px; right:-4px; width:12px; height:25px; background:#c0392b; border:2px solid #000; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .switch-plates { height: 60px; background-image: linear-gradient(to bottom, transparent 45%, #000 45%, #000 55%, transparent 55%); background-size: 100% 10px;}
        .switch-minimal { height: 40px; }
        .switch-minimal::after { content:''; position: absolute; width: 15px; height: 15px; background: var(--accent-gold); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid #000; box-shadow: 0 0 10px var(--accent-gold);}
        .grip-rubber-fins { height: 100px; border-top: 3px solid #111; border-bottom: 3px solid #111; }
        .grip-leather-wrap { height: 110px; border-radius: 5px; }
        .grip-metal-rings { height: 90px; background: repeating-linear-gradient(to bottom, #333 0, #333 15px, #111 15px, #111 18px); }
        .grip-smooth { height: 100px; }
        .grip-smooth::after { content:'Galactic Forge'; position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 0.6rem; color: rgba(255,255,255,0.3); letter-spacing: 2px; transform: rotate(-90deg); }
        .pommel-cap { height: 25px; border-radius: 0 0 10px 10px; border-top: 3px solid #222; }
        .pommel-skull-crusher { height: 35px; border-radius: 0 0 50% 50%; position: relative; }
        .pommel-skull-crusher::after { content:''; position:absolute; bottom:-5px; left:50%; transform:translateX(-50%); width:10px; height:10px; background:#111; border-radius:50%; border:2px solid #555; }
        .pommel-flat { height: 15px; border-top: 2px solid #000; }
        .pommel-spiked { height: 40px; clip-path: polygon(20% 0, 80% 0, 100% 100%, 0 100%); transform: rotate(180deg); border-bottom: none !important;}

        .cart-container, .admin-container, .login-container { background: var(--bg-panel); padding: 30px; border-radius: 12px; border: 1px solid #333; max-width: 800px; margin: 0 auto;}
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th { text-align: left; padding: 15px; border-bottom: 2px solid #333; color: var(--accent-gold); }
        .data-table td { padding: 15px; border-bottom: 1px solid #333; vertical-align: top;}
        .cart-summary { margin-top: 30px; text-align: right; }
        .cart-total-price { color: var(--accent-gold); font-weight: bold; font-size: 2rem; }
        .delete-item-btn { background: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;}
        .empty-msg { text-align: center; padding: 50px; font-size: 1.2rem; color: #aaa; font-style: italic;}
        .site-footer { margin-top: auto; padding: 20px; text-align: center; border-top: 1px solid #333; font-size: 0.9rem; color: #666; }
        .admin-link { color: #333; text-decoration: none; cursor: pointer; transition: color 0.3s;}
        .admin-link:hover { color: var(--accent-gold); }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--accent-gold); }
        .form-group input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; }
        .login-msg { margin-top: 15px; text-align: center; font-weight: bold; }
        .success { color: #2ecc71; } .error { color: #e74c3c; }

        /* --- DURUM ETÄ°KETLERÄ° VE BUTONLARI --- */
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 5px;}
        .status-hazirlaniyor { background: #f39c12; color: #fff; }
        .status-teslim { background: #2ecc71; color: #fff; }
        .status-iptal { background: #e74c3c; color: #fff; }
        .status-gecikme { background: #9b59b6; color: #fff; }
        
        .admin-actions-cell { display: flex; gap: 5px; flex-wrap: wrap; }
        .admin-action-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; color: white; transition: opacity 0.2s; }
        .admin-action-btn:hover { opacity: 0.8; }
        .btn-teslim { background: #27ae60; }
        .btn-iptal { background: #c0392b; }
        .btn-gecikme { background: #8e44ad; }

        /* --- YENÄ° CSS: ADMÄ°N PANELÄ° GENÄ°ÅžLETME (SHOW MORE) --- */
        /* DetaylarÄ± iÃ§eren kapsayÄ±cÄ± kutu */
        .detail-container {
            max-height: 60px; /* KapalÄ±ykenki yÃ¼kseklik sÄ±nÄ±rÄ± */
            overflow: hidden; /* TaÅŸan kÄ±smÄ± gizle */
            position: relative;
            transition: max-height 0.4s ease-in-out; /* AÃ§Ä±lma animasyonu */
        }
        /* Kutunun altÄ±ndaki "gÃ¶lge" efekti */
        .detail-container::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 30px;
            background: linear-gradient(to bottom, transparent, var(--bg-panel));
            pointer-events: none; opacity: 1; transition: opacity 0.3s;
        }
        /* Kutu aÃ§Ä±ldÄ±ÄŸÄ±nda */
        .detail-container.expanded { max-height: 500px; }
        .detail-container.expanded::after { opacity: 0; }
        /* GÃ¶ster/Gizle butonu */
        .detail-toggle-btn {
            background: none; border: none; color: var(--accent-gold); cursor: pointer;
            font-size: 0.8rem; padding: 5px 0; margin-top: 5px; font-weight: bold;
        }
        .detail-toggle-btn:hover { text-decoration: underline; }

        @media (max-width: 900px) { .workshop-layout { grid-template-columns: 1fr; } .saber-container { transform: rotate(0deg) scale(0.8); margin: 50px 0;} }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="brand">Galaktik AtÃ¶lye</div>
    <ul class="nav-links">
        <li><button class="nav-btn active" onclick="navigateTo('home')">Ana Sayfa</button></li>
        <li><button class="nav-btn" onclick="navigateTo('workshop')">AtÃ¶lye</button></li>
        <li><button class="nav-btn" onclick="navigateTo('cart')">Sepetim <span class="cart-badge" id="navCartCount">0</span></button></li>
        <li><button class="nav-btn" onclick="navigateTo('notifications')">SipariÅŸ Takibi</button></li>
    </ul>
</nav>

<section id="home-view" class="view-section active-view">
    <div class="hero-banner">
        <img src="https://picsum.photos/id/103/500/300" alt="Galaktik Silah" class="corner-ad ad-tl">
        <img src="https://picsum.photos/id/104/500/300" alt="Yeni Sezon KÄ±lÄ±Ã§" class="corner-ad ad-br">
        <h1 class="hero-title">GerÃ§ek GÃ¼cÃ¼ Hisset</h1>
        <p class="hero-subtitle">SipariÅŸleriniz artÄ±k doÄŸrudan galaktik sunucularÄ±mÄ±za iletiliyor. Efsaneni yarat ve savaÅŸa katÄ±l.</p>
        <button class="cta-btn" onclick="navigateTo('workshop')">AtÃ¶lyeye Gir</button>
    </div>
</section>

<section id="workshop-view" class="view-section">
    <div class="workshop-layout">
        <div class="workshop-preview">
            <div class="saber-container" id="saberContainer">
                <div class="blade" id="saberBlade"></div>
                <div class="handle-assembly" id="saberAssembly"></div>
            </div>
        </div>
        <div class="panel controls">
            <h3>KÄ±lÄ±Ã§ KonfigÃ¼rasyonu</h3>
            <div class="part-category-title">GÃ¼Ã§ Kristali (Renk)</div>
            <div class="option-grid" id="colorOptions"></div>
            <div class="part-category-title">1. Ãœst Kapak (Emitter)</div>
            <div class="option-grid" style="grid-template-columns: 1fr 1fr;" id="emitterOptions"></div>
            <div class="part-category-title">2. Ana GÃ¶vde (Switch)</div>
            <div class="option-grid" style="grid-template-columns: 1fr 1fr;" id="switchOptions"></div>
            <div class="part-category-title">3. Tutma Yeri (Grip)</div>
            <div class="option-grid" style="grid-template-columns: 1fr 1fr;" id="gripOptions"></div>
            <div class="part-category-title">4. Alt Kapak (Pommel)</div>
            <div class="option-grid" style="grid-template-columns: 1fr 1fr;" id="pommelOptions"></div>
            <div class="workshop-actions">
                <button class="action-btn btn-secondary" id="testBtn">KÄ±lÄ±cÄ± Test Et (AÃ§/Kapat)</button>
                <span class="price-display" id="workshopPrice">0 â‚º</span>
                <button class="action-btn btn-primary" id="addToCartBtn">ðŸ›’ Sepete Ekle</button>
            </div>
        </div>
    </div>
</section>

<section id="cart-view" class="view-section">
    <h2 style="margin-bottom: 30px; color: var(--accent-gold);">Sepetiniz</h2>
    <div class="cart-container">
        <div style="margin-bottom: 20px;">
             <label style="color: #aaa;">SipariÅŸ E-posta Adresi (Takip iÃ§in gereklidir):</label>
             <input type="email" id="customerEmail" placeholder="ornek@mail.com" style="width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; margin-top: 5px;">
        </div>
        <table class="data-table">
            <thead><tr><th>ÃœrÃ¼n Ã–zeti</th><th>Fiyat</th><th>Ä°ÅŸlem</th></tr></thead>
            <tbody id="fullCartList"></tbody>
        </table>
        <div class="cart-summary hidden" id="cartSummarySection">
            <div style="font-size: 1.5rem; margin-bottom: 20px;">Toplam Tutar: <span class="cart-total-price" id="fullCartTotal">0 â‚º</span></div>
            <button class="cta-btn" onclick="submitOrderToServer()">SipariÅŸi Sunucuya GÃ¶nder</button>
        </div>
    </div>
</section>

<section id="notifications-view" class="view-section">
    <div class="cart-container">
        <h2 style="color: var(--accent-gold); margin-bottom: 20px;">SipariÅŸ Takibi</h2>
        <p style="color: #aaa; margin-bottom: 15px;">SipariÅŸ verirken kullandÄ±ÄŸÄ±nÄ±z e-posta adresini girerek geÃ§miÅŸ sipariÅŸlerinizin durumunu sorgulayabilirsiniz.</p>
        <div style="display: flex; gap: 10px; margin-bottom: 30px;">
            <input type="email" id="trackEmailInput" placeholder="E-posta adresiniz..." style="flex-grow: 1; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px;">
            <button class="action-btn btn-primary" style="width: auto; margin: 0;" onclick="fetchUserNotifications()">Sorgula</button>
        </div>

        <table class="data-table">
            <thead><tr><th>SipariÅŸ No & Tarih</th><th>Ä°Ã§erik</th><th>Durum</th></tr></thead>
            <tbody id="notificationList">
                <tr><td colspan="3" class="empty-msg">HenÃ¼z sorgulama yapÄ±lmadÄ±.</td></tr>
            </tbody>
        </table>
    </div>
</section>

<section id="login-view" class="view-section">
    <div class="login-container">
        <h2 style="text-align: center; color: var(--accent-gold); margin-bottom: 30px;">YÃ¶netici GiriÅŸi</h2>
        <div class="login-form">
            <div class="form-group">
                <label for="adminEmail">E-posta Adresi</label>
                <input type="email" id="adminEmail" value="admin@galaktik.com">
            </div>
            <div class="form-group">
                <label for="adminPassword">Åžifre</label>
                <input type="password" id="adminPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="cta-btn" onclick="loginToServer()">GiriÅŸ Yap</button>
            <div class="login-msg" id="loginMessage"></div>
        </div>
    </div>
</section>

<section id="admin-view" class="view-section">
     <h2 style="margin-bottom: 30px; color: var(--accent-gold);">Sunucu Paneli - SipariÅŸ YÃ¶netimi</h2>
     <div class="admin-container">
         <button class="action-btn btn-secondary" onclick="fetchAdminOrders()" style="width: auto; margin-bottom: 20px;">SipariÅŸleri Yenile</button>
         <table class="data-table">
             <thead><tr><th>ID / MÃ¼ÅŸteri</th><th>KonfigÃ¼rasyon DetaylarÄ±</th><th>Tutar & Durum</th><th>Ä°ÅŸlemler</th></tr></thead>
             <tbody id="adminOrderList"><tr style="display: contents;"><td colspan="4" class="empty-msg">Veri bekleniyor...</td></tr></tbody>
         </table>
     </div>
</section>

<footer class="site-footer">
    <p>&copy; 2023 Galaktik Silah AtÃ¶lyesi. Final Sistem.</p>
    <span class="admin-link" onclick="checkAdminAccess()">YÃ¶netici GiriÅŸi</span>
</footer>

<script>
    const API_URL = "http://localhost:3000/api";
    let authToken = localStorage.getItem('adminToken');

    const partsData = {
        colors: [ { id: 'c1', name: 'Saf Mavi', hex: '#0088ff', price: 500 }, { id: 'c2', name: 'ZÃ¼mrÃ¼t YeÅŸili', hex: '#2ecc71', price: 600 }, { id: 'c3', name: 'Kan KÄ±rmÄ±zÄ±sÄ±', hex: '#e74c3c', price: 450 }, { id: 'c4', name: 'Ametist Moru', hex: '#9b59b6', price: 750 }, { id: 'c5', name: 'AltÄ±n SarÄ±sÄ±', hex: '#f1c40f', price: 700 } ],
        emitters: [ { id: 'e1', name: 'Graflex Tip (Krom)', price: 400, css: 'emitter-graflex tex-chrome' }, { id: 'e2', name: 'Obi-Wan Boyunlu (BakÄ±r)', price: 550, css: 'emitter-obi tex-copper', hasNeck: true }, { id: 'e3', name: 'Vader BaÅŸlÄ±ÄŸÄ± (Siyah)', price: 500, css: 'emitter-vader tex-dark-metal' }, { id: 'e4', name: 'Kraliyet TacÄ± (AltÄ±n)', price: 650, css: 'emitter-crown tex-gold' } ],
        switches: [ { id: 's1', name: 'KelepÃ§e Tipi (Krom)', price: 350, css: 'switch-clamp tex-chrome' }, { id: 's2', name: 'KÄ±rmÄ±zÄ± DÃ¼ÄŸmeli Kutu', price: 400, css: 'switch-box-red tex-chrome' }, { id: 's3', name: 'PlakalÄ± GÃ¶vde (Siyah)', price: 300, css: 'switch-plates tex-dark-metal' }, { id: 's4', name: 'Minimalist AltÄ±n TuÅŸ', price: 500, css: 'switch-minimal tex-gold' } ],
        grips: [ { id: 'g1', name: 'KauÃ§uk Kanatlar (T-Rex)', price: 450, css: 'grip-rubber-fins tex-rubber' }, { id: 'g2', name: 'GerÃ§ek Deri SargÄ± (Kahve)', price: 600, css: 'grip-leather-wrap tex-leather' }, { id: 'g3', name: 'Metal HalkalÄ± (Siyah)', price: 400, css: 'grip-metal-rings tex-dark-metal' }, { id: 'g4', name: 'PÃ¼rÃ¼zsÃ¼z Krom Silindir', price: 350, css: 'grip-smooth tex-chrome' } ],
        pommels: [ { id: 'p1', name: 'Standart Kapak (Krom)', price: 200, css: 'pommel-cap tex-chrome' }, { id: 'p2', name: 'KafatasÄ± KÄ±rÄ±cÄ± (BakÄ±r)', price: 350, css: 'pommel-skull-crusher tex-copper' }, { id: 'p3', name: 'DÃ¼z Kapak (Siyah)', price: 150, css: 'pommel-flat tex-dark-metal' }, { id: 'p4', name: 'Ã‡ivili UÃ§ (AltÄ±n)', price: 400, css: 'pommel-spiked tex-gold' } ]
    };
    let appState = { currentView: 'home', workshop: { color: partsData.colors[0], emitter: partsData.emitters[0], switchPart: partsData.switches[0], grip: partsData.grips[0], pommel: partsData.pommels[0], isSaberOn: false }, cart: [] };

    const DOM = {
        views: { home: document.getElementById('home-view'), workshop: document.getElementById('workshop-view'), cart: document.getElementById('cart-view'), login: document.getElementById('login-view'), admin: document.getElementById('admin-view'), notifications: document.getElementById('notifications-view') },
        navBtns: document.querySelectorAll('.nav-btn'), navCartCount: document.getElementById('navCartCount'),
        saber: { container: document.getElementById('saberContainer'), assembly: document.getElementById('saberAssembly') },
        wsCtrl: { colors: document.getElementById('colorOptions'), emitters: document.getElementById('emitterOptions'), switches: document.getElementById('switchOptions'), grips: document.getElementById('gripOptions'), pommels: document.getElementById('pommelOptions'), price: document.getElementById('workshopPrice'), testBtn: document.getElementById('testBtn'), addBtn: document.getElementById('addToCartBtn') },
        cart: { list: document.getElementById('fullCartList'), total: document.getElementById('fullCartTotal'), summary: document.getElementById('cartSummarySection'), emailInput: document.getElementById('customerEmail') },
        login: { email: document.getElementById('adminEmail'), pass: document.getElementById('adminPassword'), msg: document.getElementById('loginMessage') },
        admin: { list: document.getElementById('adminOrderList') },
        notif: { emailInput: document.getElementById('trackEmailInput'), list: document.getElementById('notificationList') }
    };

    /* --- FONKSÄ°YONLAR --- */
    function navigateTo(viewName) {
        Object.values(DOM.views).forEach(v => v.classList.remove('active-view')); DOM.navBtns.forEach(b => b.classList.remove('active'));
        DOM.views[viewName].classList.add('active-view');
        if(viewName === 'cart') renderCartPage();
        const btnIdx = ['home', 'workshop', 'cart', 'notifications'].indexOf(viewName); 
        if (btnIdx >= 0 && DOM.navBtns[btnIdx]) DOM.navBtns[btnIdx].classList.add('active');
        appState.currentView = viewName;
    }

    function initWorkshopUI() {
        partsData.colors.forEach(c => { const btn = document.createElement('div'); btn.className = 'color-btn'; btn.style.background = c.hex; btn.onclick = () => { appState.workshop.color = c; updateWorkshop(); }; DOM.wsCtrl.colors.appendChild(btn); });
        const createPartBtns = (dataArray, container, stateKey) => { dataArray.forEach(part => { const btn = document.createElement('button'); btn.className = 'part-btn'; btn.innerHTML = `${part.name} <span>${part.price} â‚º</span>`; btn.onclick = () => { appState.workshop[stateKey] = part; updateWorkshop(); }; container.appendChild(btn); }); };
        createPartBtns(partsData.emitters, DOM.wsCtrl.emitters, 'emitter'); createPartBtns(partsData.switches, DOM.wsCtrl.switches, 'switchPart'); createPartBtns(partsData.grips, DOM.wsCtrl.grips, 'grip'); createPartBtns(partsData.pommels, DOM.wsCtrl.pommels, 'pommel');
        updateWorkshop();
    }

    function updateWorkshop() {
        const st = appState.workshop;
        document.documentElement.style.setProperty('--blade-color', st.color.hex);
        DOM.saber.assembly.innerHTML = '';
        const addPart = (partData, extraClass = '') => { const div = document.createElement('div'); div.className = `hilt-part ${partData.css} ${extraClass}`; DOM.saber.assembly.appendChild(div); }
        addPart(st.emitter); if(st.emitter.hasNeck) addPart({css: 'emitter-obi-neck tex-copper'}, 'no-shadow');
        addPart(st.switchPart); addPart(st.grip); addPart(st.pommel);
        const totalPrice = st.color.price + st.emitter.price + st.switchPart.price + st.grip.price + st.pommel.price;
        DOM.wsCtrl.price.textContent = `${totalPrice} â‚º`;
        const updateBtnStates = (container, selectedId) => { Array.from(container.children).forEach(btn => { const isActive = btn.style.background === st.color.hex || btn.innerHTML.includes(selectedId); btn.classList.toggle('active', isActive); }); }
        updateBtnStates(DOM.wsCtrl.colors, st.color.id); updateBtnStates(DOM.wsCtrl.emitters, st.emitter.name); updateBtnStates(DOM.wsCtrl.switches, st.switchPart.name); updateBtnStates(DOM.wsCtrl.grips, st.grip.name); updateBtnStates(DOM.wsCtrl.pommels, st.pommel.name);
        DOM.saber.container.classList.toggle('active', st.isSaberOn); DOM.wsCtrl.testBtn.textContent = st.isSaberOn ? "KÄ±lÄ±cÄ± Kapat" : "KÄ±lÄ±cÄ± Test Et (AÃ§)"; DOM.wsCtrl.testBtn.style.background = st.isSaberOn ? "#c0392b" : "#333";
    }

    DOM.wsCtrl.addBtn.addEventListener('click', () => {
        const st = appState.workshop; const total = st.color.price + st.emitter.price + st.switchPart.price + st.grip.price + st.pommel.price;
        appState.cart.push({ id: Date.now(), config: { ...st }, total: total });
        DOM.navCartCount.textContent = appState.cart.length; DOM.wsCtrl.addBtn.innerHTML = "âœ… Eklendi!"; setTimeout(() => DOM.wsCtrl.addBtn.innerHTML = "ðŸ›’ Sepete Ekle", 1000);
    });

    function renderCartPage() {
        DOM.cart.list.innerHTML = ''; let grandTotal = 0;
        if (appState.cart.length === 0) { DOM.cart.list.innerHTML = '<tr><td colspan="3" class="empty-msg">Sepetiniz boÅŸ.</td></tr>'; DOM.cart.summary.classList.add('hidden'); return; }
        DOM.cart.summary.classList.remove('hidden');
        appState.cart.forEach(item => { grandTotal += item.total; DOM.cart.list.innerHTML += `<tr><td><strong>Ã–zel TasarÄ±m IÅŸÄ±n KÄ±lÄ±cÄ±</strong><br><span style="font-size:0.85rem; color:#aaa;">${item.config.color.name} Kristal, ${item.config.emitter.name}, ${item.config.grip.name}...</span></td><td style="font-weight:bold;">${item.total} â‚º</td><td><button class="delete-item-btn" onclick="removeFromCart(${item.id})">Sil</button></td></tr>`; });
        DOM.cart.total.textContent = `${grandTotal} â‚º`;
    }
    window.removeFromCart = (id) => { appState.cart = appState.cart.filter(i => i.id !== id); DOM.navCartCount.textContent = appState.cart.length; renderCartPage(); };

    /* --- SUNUCU Ä°LETÄ°ÅžÄ°MÄ° --- */
    async function submitOrderToServer() {
        if(appState.cart.length === 0) return alert("Sepet boÅŸ!");
        const email = DOM.cart.emailInput.value.trim();
        if(!email || !email.includes('@')) return alert("LÃ¼tfen geÃ§erli bir e-posta adresi girin.");
        const orderData = { customerEmail: email, items: appState.cart, grandTotal: parseInt(DOM.cart.total.textContent) };
        try {
            const response = await fetch(`${API_URL}/orders`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
            const result = await response.json();
            if(result.success) {
                alert(`SipariÅŸiniz AlÄ±ndÄ±!\nSipariÅŸ No: ${result.orderID}\nDurum: HazÄ±rlanÄ±yor`);
                appState.cart = []; DOM.navCartCount.textContent = 0; renderCartPage(); DOM.cart.emailInput.value = '';
                DOM.notif.emailInput.value = email; navigateTo('notifications'); fetchUserNotifications();
            }
        } catch (error) { alert("Sunucu baÄŸlantÄ± hatasÄ±!"); }
    }

    function checkAdminAccess() { if(authToken) { navigateTo('admin'); fetchAdminOrders(); } else { navigateTo('login'); } }

    async function loginToServer() {
        const email = DOM.login.email.value; const password = DOM.login.pass.value;
        DOM.login.msg.textContent = "BaÄŸlanÄ±lÄ±yor..."; DOM.login.msg.className = 'login-msg';
        try {
            const response = await fetch(`${API_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
            const result = await response.json();
            if(result.success) {
                authToken = result.token; localStorage.setItem('adminToken', authToken);
                DOM.login.msg.textContent = result.message; DOM.login.msg.classList.add('success');
                setTimeout(() => { checkAdminAccess(); DOM.login.msg.textContent = '';DOM.login.pass.value=''; }, 1000);
            } else { DOM.login.msg.textContent = result.message; DOM.login.msg.classList.add('error'); }
        } catch (error) { DOM.login.msg.textContent = "Sunucu hatasÄ±!"; DOM.login.msg.classList.add('error'); }
    }

    // --- YENÄ°: GÃœNCELLENMÄ°Åž ADMÄ°N PANELÄ° FONKSÄ°YONU (GÃ¶ster/Gizle Ã–zellikli) ---
    async function fetchAdminOrders() {
        if(!authToken) return navigateTo('login');
        DOM.admin.list.innerHTML = '<tr><td colspan="4" class="empty-msg">Veri Ã§ekiliyor...</td></tr>';
        try {
            const response = await fetch(`${API_URL}/admin/orders`, { headers: { 'Authorization': authToken } });
            if(response.status === 403) { authToken = null; localStorage.removeItem('adminToken'); return navigateTo('login'); }
            const orders = await response.json();
            DOM.admin.list.innerHTML = '';
            if(orders.length === 0) { DOM.admin.list.innerHTML = '<tr><td colspan="4" class="empty-msg">HenÃ¼z sipariÅŸ yok.</td></tr>'; return; }

            orders.forEach(order => {
                let detailsListHtml = '<ul style="font-size:0.85rem; padding-left:15px; margin:0;">';
                order.items.forEach(item => { const c = item.config; detailsListHtml += `<li><strong style="color:var(--accent-gold)">${c.color.name}</strong> Kristal, ${c.emitter.name}, ${c.switchPart.name}, ${c.grip.name}, ${c.pommel.name}</li>`; });
                detailsListHtml += '</ul>';
                
                let expandableDetailsHtml = '';
                const containerId = 'details-container-' + order.serverID; const btnId = 'details-btn-' + order.serverID;
                if (order.items.length > 0) {
                    expandableDetailsHtml = `<div id="${containerId}" class="detail-container">${detailsListHtml}</div>`;
                    if(order.items.length > 1 || detailsListHtml.length > 150) {
                         expandableDetailsHtml += `<button id="${btnId}" class="detail-toggle-btn" onclick="toggleDetails('${containerId}', '${btnId}')">â–¼ DetaylarÄ± GÃ¶ster</button>`;
                    } else { expandableDetailsHtml = `<div class="detail-container expanded" style="max-height:none">${detailsListHtml}</div>`; }
                }

                let statusClass = 'status-hazirlaniyor';
                if(order.status === 'Teslim Edildi') statusClass = 'status-teslim';
                if(order.status === 'Ä°ptal Edildi') statusClass = 'status-iptal';
                if(order.status === 'Gecikme YaÅŸanÄ±yor') statusClass = 'status-gecikme';

                DOM.admin.list.innerHTML += `<tr><td><strong>${order.serverID}</strong><br><span style="font-size:0.8rem">${order.serverDate}</span><br>${order.customerEmail}</td><td style="vertical-align: top;">${expandableDetailsHtml}</td><td><div style="font-weight:bold;">${order.grandTotal} â‚º</div><span class="status-badge ${statusClass}">${order.status}</span></td><td class="admin-actions-cell"><button class="admin-action-btn btn-teslim" onclick="updateOrderStatus('${order.serverID}', 'Teslim Edildi')">Teslim</button><button class="admin-action-btn btn-iptal" onclick="updateOrderStatus('${order.serverID}', 'Ä°ptal Edildi')">Ä°ptal</button><button class="admin-action-btn btn-gecikme" onclick="updateOrderStatus('${order.serverID}', 'Gecikme YaÅŸanÄ±yor')">Gecikme</button></td></tr>`;
            });
        } catch (error) { DOM.admin.list.innerHTML = '<tr><td colspan="4" class="empty-msg error">Hata oluÅŸtu!</td></tr>'; }
    }

    // YENÄ°: DetaylarÄ± aÃ§Ä±p kapatan yardÄ±mcÄ± fonksiyon
    function toggleDetails(containerId, btnId) {
        const container = document.getElementById(containerId); const btn = document.getElementById(btnId);
        container.classList.toggle('expanded');
        btn.textContent = container.classList.contains('expanded') ? 'â–² DetaylarÄ± Gizle' : 'â–¼ DetaylarÄ± GÃ¶ster';
    }

    async function updateOrderStatus(orderId, newStatus) {
        if(!confirm(`SipariÅŸ ${orderId} durumu "${newStatus}" olarak deÄŸiÅŸtirilecek. Emin misiniz?`)) return;
        try {
            const response = await fetch(`${API_URL}/admin/orders/${orderId}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, body: JSON.stringify({ newStatus }) });
            if(response.ok) { fetchAdminOrders(); } else { alert("GÃ¼ncelleme baÅŸarÄ±sÄ±z!"); }
        } catch(e) { alert("Sunucu hatasÄ±!"); }
    }

    async function fetchUserNotifications() {
        const email = DOM.notif.emailInput.value.trim();
        if(!email) return alert("LÃ¼tfen e-posta girin.");
        DOM.notif.list.innerHTML = '<tr><td colspan="3" class="empty-msg">SorgulanÄ±yor...</td></tr>';
        try {
            const response = await fetch(`${API_URL}/user/orders/${email}`);
            const orders = await response.json();
            DOM.notif.list.innerHTML = '';
            if(orders.length === 0) { DOM.notif.list.innerHTML = '<tr><td colspan="3" class="empty-msg">Bu e-posta ile kayÄ±tlÄ± sipariÅŸ bulunamadÄ±.</td></tr>'; return; }
            orders.forEach(order => {
                let statusClass = 'status-hazirlaniyor';
                if(order.status === 'Teslim Edildi') statusClass = 'status-teslim';
                if(order.status === 'Ä°ptal Edildi') statusClass = 'status-iptal';
                if(order.status === 'Gecikme YaÅŸanÄ±yor') statusClass = 'status-gecikme';
                DOM.notif.list.innerHTML += `<tr><td><strong>${order.serverID}</strong><br><span style="font-size:0.8rem">${order.serverDate}</span></td><td>${order.items.length} ParÃ§a IÅŸÄ±n KÄ±lÄ±cÄ±<br>Toplam: ${order.grandTotal} â‚º</td><td><span class="status-badge ${statusClass}">${order.status}</span></td></tr>`;
            });
        } catch (error) { DOM.notif.list.innerHTML = '<tr><td colspan="3" class="empty-msg error">Sunucu hatasÄ±!</td></tr>'; }
    }

    DOM.wsCtrl.testBtn.addEventListener('click', () => { appState.workshop.isSaberOn = !appState.workshop.isSaberOn; updateWorkshop(); });
    initWorkshopUI(); navigateTo('home');
</script>
</body>
</html>


